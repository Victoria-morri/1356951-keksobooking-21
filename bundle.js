(()=>{"use strict";window.load=function({onSuccess:e,onError:t,url:n,method:o,dataX:r}){const i=new XMLHttpRequest;i.responseType="json",i.addEventListener("load",(function(){let n="";switch(i.status){case 200:e(i.response);break;case 400:n="Неверный запрос";break;case 401:n="Пользователь не авторизован";break;case 404:n="Ничего не найдено";break;default:n="Cтатус ответа: : "+i.status+" "+i.statusText}n&&t(n)})),i.addEventListener("error",(function(){t("Произошла ошибка соединения")})),i.open(o,n),i.send(r)},(()=>{const e=function(e){for(let t=0;t<e.length;t++)e[t].setAttribute("disabled","disabled")},t=function(e){for(let t=0;t<e.length;t++)e[t].removeAttribute("disabled")},n=document.querySelector(".notice"),o=document.querySelector(".map"),r=n.querySelector(".ad-form"),i=r.querySelectorAll("fieldset"),s=r.querySelectorAll("select"),l=document.querySelector(".map__filters"),d=l.querySelectorAll("fieldset"),c=l.querySelectorAll("select"),u=Array.from(d).concat(Array.from(c)),a=Array.from(i).concat(Array.from(s));window.utils={getNumber:function(e){return"number"!=typeof e?parseInt(e,10):e},disable:e,undisable:t,activate:function(e,n,o){e.classList.remove(n),t(o)},resetMap:function(){l.reset(),o.classList.add("map--faded"),e(u)},resetForm:function(){r.reset(),r.classList.add("ad-form--disabled"),e(a)},mapElement:o,noticeElement:n,adFormElement:r,mapFiltersElement:l,mapFieldsArray:u,formFieldsArray:a}})(),(()=>{const e=function(e,t,n,o){const i=window.utils.getNumber(e),s=window.utils.getNumber(n);r.value=`${i+t}, ${s+o}`},t=function({min:e,max:t,position:n}){let o;return o=n>t?t:n<e?e:n,o},n=document.querySelector(".map__pin--main"),o=document.querySelector(".map__pins"),r=document.querySelector("#address");window.position={startAdressInput:function(){const e=window.utils.getNumber(n.style.left),t=window.utils.getNumber(n.style.top);r.value=`${e+31}, ${t+31}`},resetMainPin:function(){n.style.top="375px",n.style.left="570px"},movePin:function(r){r.preventDefault();let i={x:r.clientX,y:r.clientY},s=n.offsetLeft,l=n.offsetTop;const d=function(o){o.preventDefault();const r=i.x-o.clientX,d=i.y-o.clientY;l=t({min:46,max:546,position:n.offsetTop-d}),s=t({min:-31,max:1169,position:n.offsetLeft-r}),l!==window.utils.getNumber(n.style.top)&&(i.y=o.clientY),s!==window.utils.getNumber(n.style.left)&&(i.x=o.clientX),n.style.top=l+"px",n.style.left=s+"px",e(s,31,l,84)},c=function(t){t.preventDefault(),o.removeEventListener("mousemove",d),document.removeEventListener("mouseup",c),e(s,31,l,84)};o.addEventListener("mousemove",d),document.addEventListener("mouseup",c)},mapPinMainElement:n}})(),(()=>{const e=function(e){const n=t.cloneNode(!0);return n.style=`left: ${e.location.x-25}px; top: ${e.location.y-70}px`,n.querySelector("img").src=e.author.avatar,n.querySelector("img").alt=e.offer.title,n},t=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={clearAll:function(){const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t=0;t<e.length;t++)e[t].remove()},renderAll:function(t){const n=document.createDocumentFragment();for(let o=0;o<t.length;o++)n.appendChild(e(t[o]));return n}}})(),(()=>{const e=["wifi","dishwasher","parking","washer","elevator","conditioner"],t={1:"а",2:"ы",3:"ы",4:"ы",5:"",6:"",7:"",8:"",9:"",0:""},n={1:"я",2:"ей",3:"ей",4:"ей",5:"ей",6:"ей",7:"ей",8:"ей",9:"ей",0:"ей"},o={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},r=document.querySelector("#card").content.querySelector(".map__card"),i=function(e){return e%100<10?e%100:e%100%10},s=function(s){const l=r.cloneNode(!0);if(s.author.avatar?l.querySelector(".popup__avatar").src=s.author.avatar:l.querySelector(".popup__avatar").hidden=!0,s.offer.title?l.querySelector(".popup__title").textContent=s.offer.title:l.querySelector(".popup__title").hidden=!0,s.offer.address?l.querySelector(".popup__text--address").textContent=s.offer.address:l.querySelector(".popup__text--address").hidden=!0,s.offer.price,l.querySelector(".popup__text--price").textContent=s.offer.price,s.offer.type){const e=s.offer.type;l.querySelector(".popup__type").textContent=o[e]}else l.querySelector(".popup__type").hidden=!0;if(s.offer.rooms&&s.offer.guests?l.querySelector(".popup__text--capacity").textContent=`${s.offer.rooms} комнат${t[i(s.offer.rooms)]} для ${s.offer.guests} гост${n[i(s.offer.guests)]}`:l.querySelector(".popup__text--capacity").hidden=!0,""!==s.offer.checkin&&""!==s.offer.checkout?l.querySelector(".popup__text--time").textContent=`Заезд после ${s.offer.checkin}, выезд до ${s.offer.checkout}`:l.querySelector(".popup__text--time").hidden=!0,s.offer.features){const t=l.querySelector(".popup__features"),n=s.offer.features;e.forEach((function(e){n.includes(e)||t.querySelector(".popup__feature--"+e).classList.add("hidden")}))}else l.querySelector(".popup__features").hidden=!0;s.offer.description?l.querySelector(".popup__description").textContent=s.offer.description:l.querySelector(".popup__description").hidden=!0;const d=l.querySelector(".popup__photos");if(0===s.offer.photos.length)d.remove();else if(1===s.offer.photos.length)d.querySelector("img").src=s.offer.photos;else if(s.offer.photos.length>1){d.querySelector("img").src=s.offer.photos[0];for(let e=1;e<s.offer.photos.length;e++){const t=d.querySelector("img").cloneNode(!0);t.src=s.offer.photos[e],d.appendChild(t)}}return l.hidden=!0,l},l=function(){const e=document.querySelectorAll(".map__card");for(let t=0;t<e.length;t++)e[t].remove()};window.card={clearPinsCards:function(){window.pin.clearAll(),l()},renderAll:function(e){const t=document.createDocumentFragment();for(let n=0;n<e.length;n++)t.appendChild(s(e[n]));return t},clearAll:l}})(),(()=>{const e=function(){t()},t=function(){i&&(i.hidden=!0,r.classList.remove("map__pin--active"),document.removeEventListener("keydown",n),o.removeEventListener("click",e),i=null,r=null)},n=function(t){"Escape"===t.key&&(t.preventDefault(),e())};let o,r,i;window.popupCard={initInteractive:function(s,l){for(let d=1;d<s.length;d++){let c=s[d],u=l[d-1];c.addEventListener("click",(function(){var s;t(),i=s=u,r=c,s.hidden=!1,r.classList.add("map__pin--active"),document.addEventListener("keydown",n),o=i.querySelector(".popup__close"),o.addEventListener("click",e)}))}},onCloseCard:e}})(),window.debounce=function(e){let t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}},(()=>{const e=window.utils.mapFiltersElement.querySelector(".map__features").querySelectorAll("input");let t={type:"any",price:"any",rooms:"any",guests:"any",features:[]};window.filter={changePriceOffer:function(e){t.price=e.target.value},changeRoomsOffer:function(e){t.rooms=e.target.value},changeHousingOffer:function(e){t.type=e.target.value},changeGuestsOffer:function(e){t.guests=e.target.value},changeMapFeatures:function(){t.features=[],e.forEach((function(e){e.checked&&t.features.push(e.value)}))},filterData:function(e){let n,o=e.filter((function(e){if(n="any"===t.type||e.offer.type===t.type,!1!==n&&("any"!==t.price?"middle"===t.price?n=e.offer.price<=5e4&&e.offer.price>=1e4:"low"===t.price?n=e.offer.price<1e4:"high"===t.price&&(n=e.offer.price>5e4):n=!0),!1!==n&&(n="any"===t.rooms||e.offer.rooms===window.utils.getNumber(t.rooms)),!1!==n){const o=window.utils.getNumber(t.guests);"any"!==t.guests&&(n="0"!==t.guests?e.offer.guests>=o:e.offer.guests===o)}if(!1!==n)for(let n=0;n<t.features.length;n++)if(!1===e.offer.features.includes(t.features[n]))return!1;return n}));return o=o.length>5?o.slice(0,5):o,o},resetOffer:function(){t={type:"any",price:"any",rooms:"any",guests:"any",features:[]}}}})(),(()=>{const e=function(e){"Escape"===e.key&&(e.preventDefault(),t())},t=function(){document.body.removeChild(r),document.removeEventListener("click",t),document.removeEventListener("keydown",e)},n=function(e){"Escape"===e.key&&(e.preventDefault(),o())},o=function(){document.body.removeChild(s),document.removeEventListener("click",o),document.removeEventListener("keydown",n)},r=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),i=r.querySelector(".error__button"),s=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),l=document.querySelector(".error-message");window.message={showSuccess:function(){document.body.appendChild(s),document.addEventListener("click",o),document.addEventListener("keydown",n)},showError:function(){document.body.appendChild(r),document.addEventListener("click",t),document.addEventListener("keydown",e),i.addEventListener("click",t)},showServerMessage:function(e){const t=document.createElement("h2");t.classList.add("error-message"),t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.color="white",t.style.fontSize="50px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},hideErrorMessage:function(){l&&l.classList.add("hidden")}}})(),(()=>{const e=function(e,t){let n=e.files[0];if(n.type.toLowerCase().startsWith("image/")){const e=new FileReader;e.addEventListener("load",(function(){t.src=e.result})),e.readAsDataURL(n)}},t=function(){let e=o.querySelector("img");e&&e.remove()},n=document.querySelector(".ad-form__upload input[type=file]"),o=document.querySelector(".ad-form__photo"),r=document.querySelector(".ad-form__field input[type=file]"),i=document.querySelector(".ad-form-header__preview img");window.loadPicture={resetAvatar:function(){i.src="img/muffin-grey.svg"},onPhotoAd:function(){t();const r=document.createElement("img");r.style.width="70px",r.style.height="70px",r.alt="Фотография помещения",o.appendChild(r),e(n,r)},onAvatarAd:function(){e(r,i)},removePhoto:t,formPhotoField:n,formFileField:r,formFilePreview:i}})(),(()=>{const e=function(){t(),window.utils.adFormElement.addEventListener("submit",s),c.addEventListener("click",i),window.utils.activate(window.utils.mapElement,"map--faded",window.utils.mapFieldsArray),window.utils.activate(window.utils.adFormElement,"ad-form--disabled",window.utils.formFieldsArray),window.load({onSuccess:v,onError:window.message.showServerMessage,url:"https://21.javascript.pages.academy/keksobooking/data",method:"GET",dataX:""})},t=function(){window.position.mapPinMainElement.removeEventListener("keydown",window.form.onKeyEnterDown),window.position.mapPinMainElement.removeEventListener("mousedown",window.form.onMouseLeftButtonDown)},n=function(t){0===t.button&&e()},o=function(t){"Enter"===t.key&&e()},r=function(){window.position.resetMainPin(),window.utils.resetForm(),window.position.startAdressInput(),window.utils.resetMap(),window.popupCard.onCloseCard(),window.card.clearPinsCards(),window.filter.resetOffer(),window.loadPicture.removePhoto(),window.loadPicture.resetAvatar(),window.position.mapPinMainElement.addEventListener("keydown",o),window.position.mapPinMainElement.addEventListener("mousedown",n)},i=function(e){e.preventDefault(),r()},s=function(e){e.preventDefault(),window.load({onSuccess:g,onError:h,url:"https://21.javascript.pages.academy/keksobooking",method:"POST",dataX:new FormData(window.utils.adFormElement)})},l=window.debounce((function(e){window.popupCard.onCloseCard(),(0,a[e.target.getAttribute("name")])(e),d()})),d=function(){var e;window.card.clearPinsCards(),e=window.filter.filterData(y),window.card.clearPinsCards(),m=window.pin.renderAll(e),f=window.card.renderAll(e),window.utils.mapElement.appendChild(f),u.appendChild(m),p=document.querySelectorAll(".map__pin"),w=document.querySelectorAll(".map__card"),window.popupCard.initInteractive(p,w)},c=window.utils.adFormElement.querySelector(".ad-form__reset"),u=window.utils.mapElement.querySelector(".map__pins"),a={"housing-type":window.filter.changeHousingOffer,"housing-price":window.filter.changePriceOffer,"housing-rooms":window.filter.changeRoomsOffer,"housing-guests":window.filter.changeGuestsOffer,features:window.filter.changeMapFeatures};let f,m,p=document.querySelectorAll(".map__pin"),w=document.querySelectorAll(".map__card"),y=[];const v=function(e){y=e,d(),window.message.hideErrorMessage(),window.utils.mapFiltersElement.addEventListener("change",l)},h=function(){window.message.showError()},g=function(){r(),window.message.showSuccess(),window.utils.adFormElement.removeEventListener("submit",s),c.removeEventListener("click",i)};window.form={onMouseLeftButtonDown:n,onKeyEnterDown:o}})(),(()=>{const e=window.utils.noticeElement.querySelector("#room_number"),t=window.utils.noticeElement.querySelector("#capacity"),n=window.utils.noticeElement.querySelector("#title"),o=window.utils.noticeElement.querySelector("#price"),r=window.utils.noticeElement.querySelector("#timein"),i=window.utils.noticeElement.querySelector("#timeout"),s=window.utils.noticeElement.querySelector("#type"),l={bungalow:0,flat:1e3,house:5e3,palace:1e4};let d=l.flat;window.formUtils={onCheckTitle:function(){const e=n.value.length;e<30?n.setCustomValidity("Минамальное количество символов 30. Дополните заголовок."):e>100?n.setCustomValidity("Максимальное количество символов 100. Сократите заголовок."):n.setCustomValidity("")},onSetPrice:function(){!function(){const e=window.utils.getNumber(o.value);e>1e6||e<d?o.setCustomValidity(`Цена может варьироваться от ${d} до 1000000руб. Скорректируйте цену.`):o.setCustomValidity(""),o.reportValidity()}()},onSetMinPrice:function(e){const t=e.target.value;d=l[t],o.min=d,o.placeholder=d,window.formUtils.setPrice()},getTimeout:function(){i.value=r.value},getTimein:function(){r.value=i.value},onDependenceOfInputs:function(){window.utils.getNumber(e.value)<window.utils.getNumber(t.value)?t.setCustomValidity("Количество гостей должно соответствовать колличеству комнат. Уменьшите количество гостей."):t.setCustomValidity("")},priceElement:o,timein:r,timeout:i,titleElement:n,roomNumberElement:e,capacityElement:t,livesType:s}})(),window.utils.disable(window.utils.mapFieldsArray),window.utils.disable(window.utils.formFieldsArray),window.position.startAdressInput(),window.position.mapPinMainElement.addEventListener("keydown",window.form.onKeyEnterDown),window.position.mapPinMainElement.addEventListener("mousedown",window.form.onMouseLeftButtonDown),window.position.mapPinMainElement.addEventListener("mousedown",window.position.movePin),window.loadPicture.formFileField.addEventListener("change",window.loadPicture.onAvatarAd),window.loadPicture.formPhotoField.addEventListener("change",window.loadPicture.onPhotoAd),window.formUtils.capacityElement.addEventListener("input",window.formUtils.onDependenceOfInputs),window.formUtils.roomNumberElement.addEventListener("input",window.formUtils.onDependenceOfInputs),window.formUtils.titleElement.addEventListener("input",window.formUtils.onCheckTitle),window.formUtils.priceElement.addEventListener("input",window.formUtils.onSetPrice),window.formUtils.livesType.addEventListener("change",window.formUtils.onSetMinPrice),window.formUtils.timein.addEventListener("change",window.formUtils.getTimeout),window.formUtils.timeout.addEventListener("change",window.formUtils.getTimein)})();