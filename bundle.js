(()=>{"use strict";window.load=function({onSuccess:e,onError:t,url:o,method:n,dataX:i}){const r=new XMLHttpRequest;r.responseType="json",r.addEventListener("load",(function(){let o="";switch(r.status){case 200:e(r.response);break;case 400:o="Неверный запрос";break;case 401:o="Пользователь не авторизован";break;case 404:o="Ничего не найдено";break;default:o="Cтатус ответа: : "+r.status+" "+r.statusText}o&&t(o)})),r.addEventListener("error",(function(){t("Произошла ошибка соединения")})),r.open(n,o),r.send(i)},(()=>{const e=function(e){for(let t=0;t<e.length;t++)e[t].setAttribute("disabled","disabled")},t=function(e){for(let t=0;t<e.length;t++)e[t].removeAttribute("disabled")},o=document.querySelector(".notice"),n=document.querySelector(".map"),i=o.querySelector(".ad-form"),r=i.querySelectorAll("fieldset"),s=i.querySelectorAll("select"),l=document.querySelector(".map__filters"),d=l.querySelectorAll("fieldset"),c=l.querySelectorAll("select"),u=Array.from(d).concat(Array.from(c)),a=Array.from(r).concat(Array.from(s));window.utils={getNumber:function(e){return"number"!=typeof e?parseInt(e,10):e},disable:e,undisable:t,activate:function(e,o,n){e.classList.remove(o),t(n)},resetMap:function(){l.reset(),n.classList.add("map--faded"),e(u)},resetForm:function(){i.reset(),i.classList.add("ad-form--disabled"),e(a)},mapElement:n,noticeElement:o,adFormElement:i,mapFiltersElement:l,mapFieldsArray:u,formFieldsArray:a}})(),(()=>{const e=function(e,t,o,n){const r=window.utils.getNumber(e),s=window.utils.getNumber(o);i.value=`${r+t}, ${s+n}`},t=function({min:e,max:t,position:o}){let n;return n=o>t?t:o<e?e:o,n},o=document.querySelector(".map__pin--main"),n=document.querySelector(".map__pins"),i=document.querySelector("#address");window.position={startAdressInput:function(){const e=window.utils.getNumber(o.style.left),t=window.utils.getNumber(o.style.top);i.value=`${e+31}, ${t+31}`},resetMainPin:function(){o.style.top="375px",o.style.left="570px"},movePin:function(i){i.preventDefault();let r={x:i.clientX,y:i.clientY},s=o.offsetLeft,l=o.offsetTop;const d=function(n){n.preventDefault();const i=r.x-n.clientX,d=r.y-n.clientY;l=t({min:46,max:546,position:o.offsetTop-d}),s=t({min:-31,max:1169,position:o.offsetLeft-i}),l!==window.utils.getNumber(o.style.top)&&(r.y=n.clientY),s!==window.utils.getNumber(o.style.left)&&(r.x=n.clientX),o.style.top=l+"px",o.style.left=s+"px",e(s,31,l,84)},c=function(t){t.preventDefault(),n.removeEventListener("mousemove",d),document.removeEventListener("mouseup",c),e(s,31,l,84)};n.addEventListener("mousemove",d),document.addEventListener("mouseup",c)},mapPinMainElement:o}})(),(()=>{const e=function(e){const o=t.cloneNode(!0);return o.style=`left: ${e.location.x-25}px; top: ${e.location.y-70}px`,o.querySelector("img").src=e.author.avatar,o.querySelector("img").alt=e.offer.title,o},t=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={clearAll:function(){const e=document.querySelectorAll(".map__pin:not(.map__pin--main)");for(let t=0;t<e.length;t++)e[t].remove()},renderAll:function(t){const o=document.createDocumentFragment();for(let n=0;n<t.length;n++)o.appendChild(e(t[n]));return o}}})(),(()=>{const e=["wifi","dishwasher","parking","washer","elevator","conditioner"],t={1:"а",2:"ы",3:"ы",4:"ы",5:"",6:"",7:"",8:"",9:"",0:""},o={1:"я",2:"ей",3:"ей",4:"ей",5:"ей",6:"ей",7:"ей",8:"ей",9:"ей",0:"ей"},n={palace:"Дворец",flat:"Квартира",house:"Дом",bungalow:"Бунгало"},i=document.querySelector("#card").content.querySelector(".map__card"),r=function(e){return e%100<10?e%100:e%100%10},s=function(s){const l=i.cloneNode(!0);if(s.author.avatar?l.querySelector(".popup__avatar").src=s.author.avatar:l.querySelector(".popup__avatar").hidden=!0,s.offer.title?l.querySelector(".popup__title").textContent=s.offer.title:l.querySelector(".popup__title").hidden=!0,s.offer.address?l.querySelector(".popup__text--address").textContent=s.offer.address:l.querySelector(".popup__text--address").hidden=!0,s.offer.price,l.querySelector(".popup__text--price").textContent=s.offer.price,s.offer.type){const e=s.offer.type;l.querySelector(".popup__type").textContent=n[e]}else l.querySelector(".popup__type").hidden=!0;if(s.offer.rooms&&s.offer.guests?l.querySelector(".popup__text--capacity").textContent=`${s.offer.rooms} комнат${t[r(s.offer.rooms)]} для ${s.offer.guests} гост${o[r(s.offer.guests)]}`:l.querySelector(".popup__text--capacity").hidden=!0,""!==s.offer.checkin&&""!==s.offer.checkout?l.querySelector(".popup__text--time").textContent=`Заезд после ${s.offer.checkin}, выезд до ${s.offer.checkout}`:l.querySelector(".popup__text--time").hidden=!0,s.offer.features){const t=l.querySelector(".popup__features"),o=s.offer.features;e.forEach((function(e){o.includes(e)||t.querySelector(".popup__feature--"+e).classList.add("hidden")}))}else l.querySelector(".popup__features").hidden=!0;s.offer.description?l.querySelector(".popup__description").textContent=s.offer.description:l.querySelector(".popup__description").hidden=!0;const d=l.querySelector(".popup__photos");if(0===s.offer.photos.length)d.remove();else if(1===s.offer.photos.length)d.querySelector("img").src=s.offer.photos;else if(s.offer.photos.length>1){d.querySelector("img").src=s.offer.photos[0];for(let e=1;e<s.offer.photos.length;e++){const t=d.querySelector("img").cloneNode(!0);t.src=s.offer.photos[e],d.appendChild(t)}}return l.hidden=!0,l},l=function(){const e=document.querySelectorAll(".map__card");for(let t=0;t<e.length;t++)e[t].remove()};window.card={clearPinsCards:function(){window.pin.clearAll(),l()},renderAll:function(e){const t=document.createDocumentFragment();for(let o=0;o<e.length;o++)t.appendChild(s(e[o]));return t},clearAll:l}})(),(()=>{const e=function(){t()},t=function(){r&&(r.hidden=!0,i.classList.remove("map__pin--active"),document.removeEventListener("keydown",o),n.removeEventListener("click",e),r=null,i=null)},o=function(t){"Escape"===t.key&&(t.preventDefault(),e())};let n,i,r;window.popupCard={initInteractive:function(s,l){for(let d=1;d<s.length;d++){let c=s[d],u=l[d-1];c.addEventListener("click",(function(){var s;t(),r=s=u,i=c,s.hidden=!1,i.classList.add("map__pin--active"),document.addEventListener("keydown",o),n=r.querySelector(".popup__close"),n.addEventListener("click",e)}))}},onCloseCard:e}})(),window.debounce=function(e){let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...o)}),500)}},(()=>{const e=window.utils.mapFiltersElement.querySelector(".map__features").querySelectorAll("input");let t={type:"any",price:"any",rooms:"any",guests:"any",features:[]};window.filter={changePriceOffer:function(e){t.price=e.target.value},changeRoomsOffer:function(e){t.rooms=e.target.value},changeHousingOffer:function(e){t.type=e.target.value},changeGuestsOffer:function(e){t.guests=e.target.value},changeMapFeatures:function(){t.features=[],e.forEach((function(e){e.checked&&t.features.push(e.value)}))},filterData:function(e){let o,n=e.filter((function(e){if(o="any"===t.type||e.offer.type===t.type,!1!==o&&("any"!==t.price?"middle"===t.price?o=e.offer.price<=5e4&&e.offer.price>=1e4:"low"===t.price?o=e.offer.price<1e4:"high"===t.price&&(o=e.offer.price>5e4):o=!0),!1!==o&&(o="any"===t.rooms||e.offer.rooms===window.utils.getNumber(t.rooms)),!1!==o){const n=window.utils.getNumber(t.guests);"any"!==t.guests&&(o="0"!==t.guests?e.offer.guests>=n:e.offer.guests===n)}if(!1!==o)for(let o=0;o<t.features.length;o++)if(!1===e.offer.features.includes(t.features[o]))return!1;return o}));return n=n.length>5?n.slice(0,5):n,n},resetOffer:function(){t={type:"any",price:"any",rooms:"any",guests:"any",features:[]}}}})(),(()=>{const e=function(e){"Escape"===e.key&&(e.preventDefault(),t())},t=function(){document.body.removeChild(i),document.removeEventListener("click",t),document.removeEventListener("keydown",e)},o=function(e){"Escape"===e.key&&(e.preventDefault(),n())},n=function(){document.body.removeChild(s),document.removeEventListener("click",n),document.removeEventListener("keydown",o)},i=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),r=i.querySelector(".error__button"),s=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),l=document.querySelector(".error-message");window.message={showSuccess:function(){document.body.appendChild(s),document.addEventListener("click",n),document.addEventListener("keydown",o)},showError:function(){document.body.appendChild(i),document.addEventListener("click",t),document.addEventListener("keydown",e),r.addEventListener("click",t)},showServerMessage:function(e){const t=document.createElement("h2");t.classList.add("error-message"),t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: red;",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.color="white",t.style.fontSize="50px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},hideErrorMessage:function(){l&&l.classList.add("hidden")}}})(),(()=>{const e=function(e,t){let o=e.files[0];if(o.type.toLowerCase().startsWith("image/")){const e=new FileReader;e.addEventListener("load",(function(){t.src=e.result})),e.readAsDataURL(o)}},t=function(){let e=n.querySelector("img");e&&e.remove()},o=document.querySelector(".ad-form__upload input[type=file]"),n=document.querySelector(".ad-form__photo"),i=document.querySelector(".ad-form__field input[type=file]"),r=document.querySelector(".ad-form-header__preview img");window.loadPicture={onPhotoAd:function(){t();const i=document.createElement("img");i.style.width="70px",i.style.height="70px",i.alt="Фотография помещения",n.appendChild(i),e(o,i)},onAvatarAd:function(){e(i,r)},removePhoto:t,formPhotoField:o,formFileField:i,formPhotoPreview:n,formFilePreview:r}})(),(()=>{const e=function(){t(),window.utils.adFormElement.addEventListener("submit",s),c.addEventListener("click",r),window.utils.activate(window.utils.mapElement,"map--faded",window.utils.mapFieldsArray),window.utils.activate(window.utils.adFormElement,"ad-form--disabled",window.utils.formFieldsArray),window.load({onSuccess:v,onError:window.message.showServerMessage,url:"https://21.javascript.pages.academy/keksobooking/data",method:"GET",dataX:""})},t=function(){window.position.mapPinMainElement.removeEventListener("keydown",window.form.onKeyEnterDown),window.position.mapPinMainElement.removeEventListener("mousedown",window.form.onMouseLeftButtonDown)},o=function(t){0===t.button&&e()},n=function(t){"Enter"===t.key&&e()},i=function(){window.position.resetMainPin(),window.utils.resetForm(),window.position.startAdressInput(),window.utils.resetMap(),window.popupCard.onCloseCard(),window.card.clearPinsCards(),window.filter.resetOffer(),window.loadPicture.removePhoto(),window.loadPicture.formFilePreview.src="img/muffin-grey.svg",window.position.mapPinMainElement.addEventListener("keydown",n),window.position.mapPinMainElement.addEventListener("mousedown",o)},r=function(e){e.preventDefault(),i()},s=function(e){e.preventDefault(),window.load({onSuccess:g,onError:h,url:"https://21.javascript.pages.academy/keksobooking",method:"POST",dataX:new FormData(window.utils.adFormElement)})},l=window.debounce((function(e){window.popupCard.onCloseCard(),(0,a[e.target.getAttribute("name")])(e),d()})),d=function(){var e;window.card.clearPinsCards(),e=window.filter.filterData(y),window.card.clearPinsCards(),m=window.pin.renderAll(e),f=window.card.renderAll(e),window.utils.mapElement.appendChild(f),u.appendChild(m),p=document.querySelectorAll(".map__pin"),w=document.querySelectorAll(".map__card"),window.popupCard.initInteractive(p,w)},c=window.utils.adFormElement.querySelector(".ad-form__reset"),u=window.utils.mapElement.querySelector(".map__pins"),a={"housing-type":window.filter.changeHousingOffer,"housing-price":window.filter.changePriceOffer,"housing-rooms":window.filter.changeRoomsOffer,"housing-guests":window.filter.changeGuestsOffer,features:window.filter.changeMapFeatures};let f,m,p=document.querySelectorAll(".map__pin"),w=document.querySelectorAll(".map__card"),y=[];const v=function(e){y=e,d(),window.message.hideErrorMessage(),window.utils.mapFiltersElement.addEventListener("change",l)},h=function(){window.message.showError()},g=function(){i(),window.message.showSuccess(),window.utils.adFormElement.removeEventListener("submit",s),c.removeEventListener("click",r)};window.form={onMouseLeftButtonDown:o,onKeyEnterDown:n}})(),(()=>{const e=window.utils.noticeElement.querySelector("#room_number"),t=window.utils.noticeElement.querySelector("#capacity"),o=window.utils.noticeElement.querySelector("#title"),n=window.utils.noticeElement.querySelector("#price"),i=window.utils.noticeElement.querySelector("#timein"),r=window.utils.noticeElement.querySelector("#timeout"),s=window.utils.noticeElement.querySelector("#type"),l={bungalow:0,flat:1e3,house:5e3,palace:1e4};let d=l.flat;window.formUtils={onCheckTitle:function(){const e=o.value.length;e<30?o.setCustomValidity("Минамальное количество символов 30. Дополните заголовок."):e>100?o.setCustomValidity("Максимальное количество символов 100. Сократите заголовок."):o.setCustomValidity("")},onSetPrice:function(){!function(){const e=window.utils.getNumber(n.value);e>1e6||e<d?n.setCustomValidity(`Цена может варьироваться от ${d} до 1000000руб. Скорректируйте цену.`):n.setCustomValidity(""),n.reportValidity()}()},onSetMinPrice:function(e){const t=e.target.value;d=l[t],n.min=d,n.placeholder=d,window.formUtils.setPrice()},getTimeout:function(){r.value=i.value},getTimein:function(){i.value=r.value},onDependenceOfInputs:function(){window.utils.getNumber(e.value)<window.utils.getNumber(t.value)?t.setCustomValidity("Количество гостей должно соответствовать колличеству комнат. Уменьшите количество гостей."):t.setCustomValidity("")},priceElement:n,timein:i,timeout:r,titleElement:o,roomNumberElement:e,capacityElement:t,livesType:s}})(),window.utils.disable(window.utils.mapFieldsArray),window.utils.disable(window.utils.formFieldsArray),window.position.startAdressInput(),window.position.mapPinMainElement.addEventListener("keydown",window.form.onKeyEnterDown),window.position.mapPinMainElement.addEventListener("mousedown",window.form.onMouseLeftButtonDown),window.position.mapPinMainElement.addEventListener("mousedown",window.position.movePin),window.loadPicture.formFileField.addEventListener("change",window.loadPicture.onAvatarAd),window.loadPicture.formPhotoField.addEventListener("change",window.loadPicture.onPhotoAd),window.formUtils.capacityElement.addEventListener("input",window.formUtils.onDependenceOfInputs),window.formUtils.roomNumberElement.addEventListener("input",window.formUtils.onDependenceOfInputs),window.formUtils.titleElement.addEventListener("input",window.formUtils.onCheckTitle),window.formUtils.priceElement.addEventListener("input",window.formUtils.onSetPrice),window.formUtils.livesType.addEventListener("change",window.formUtils.onSetMinPrice),window.formUtils.timein.addEventListener("change",window.formUtils.getTimeout),window.formUtils.timeout.addEventListener("change",window.formUtils.getTimein)})();